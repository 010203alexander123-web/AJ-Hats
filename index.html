<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AJ Hats — Gorras Colombia 🎩</title>

  <!-- Tailwind CDN (para prototipo). Para producción compilar Tailwind. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --color1: #000000; /* principal */
      --color2: #FFFFFF; /* texto */
    }
    html,body{font-family:'Poppins',system-ui,Arial; background:var(--color2); color:var(--color1);}
    .color1 { color: var(--color1); }
    .color2 { color: var(--color2); }
    /* lateral margins */
    .page-wrap { max-width:1100px; margin:24px auto; padding:0 20px; }
    /* pestañas borde radius shadow */
    .tab { border:1px solid rgba(0,0,0,0.08); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); background:var(--color2); }
    /* avatar redondo */
    .round-img { width:120px; height:120px; border-radius:9999px; object-fit:cover; border:4px solid rgba(0,0,0,0.06); }
    /* small helpers */
    .muted { color:rgba(0,0,0,0.6); font-size:0.95rem; }
    /* overlay for buy message */
    .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; }
    /* simple input file preview */
    .media-thumb { max-width:100%; height:120px; object-fit:cover; border-radius:8px; border:1px solid rgba(0,0,0,0.06); }
  </style>
</head>
<body class="antialiased">

  <div class="page-wrap">

    <!-- HEADER -->
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl font-bold color1">AJ Hats 🎩</h1>
        <p class="muted">Envíos a toda Colombia 🇨🇴 — gorras únicas y vibes cool.</p>
      </div>

      <div class="flex items-center gap-3">
        <button id="open-cart" class="px-4 py-2 tab flex items-center gap-2">🛒 Carrito <span id="cart-count" class="ml-1 text-sm rounded-full bg-black text-white px-2">0</span></button>
        <a href="mailto:zzzbrain6@gmail.com" class="px-4 py-2 tab">✉️ Contáctanos</a>
        <button id="cta-shop" class="px-4 py-2 bg-black text-white rounded-lg shadow">Comprar gorras</button>
      </div>
    </header>

    <!-- NAV TABS -->
    <nav class="flex gap-3 mb-6">
      <button class="tab px-4 py-2" data-tab="tienda">🏷️ Tienda</button>
      <button class="tab px-4 py-2" data-tab="nosotros">🫶 Más sobre nosotros</button>
      <button class="tab px-4 py-2" data-tab="opiniones">⭐ Opiniones</button>
      <button class="tab px-4 py-2" data-tab="contacto">📬 Contacto</button>
      <button class="tab px-4 py-2" data-tab="moderadores">🔧 Moderadores</button>
    </nav>

    <!-- CONTENT AREAS -->
    <main class="space-y-6">

      <!-- TIENDA -->
      <section id="tienda" class="tab p-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">Tienda — Gorras disponibles 🧢</h2>
          <div class="text-sm muted">Precio base: <span id="price-display">90.000 COP</span></div>
        </div>

        <!-- cards grid -->
        <div id="cards-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Cards renderizadas por JS -->
        </div>

        <!-- texto de venta -->
        <div class="mt-6 p-4 rounded-lg border border-dashed muted">
          <p class="text-lg font-medium">¿Listo para subir tu estilo? 🔥</p>
          <p>Gorras con estilo, hechas por gente joven. Compra fácil, envío seguro y vibra top. Añade al carrito y coordina tu pago por Nequi. 😎</p>
        </div>
      </section>

      <!-- NOSOTROS -->
      <section id="nosotros" class="tab p-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
          <div class="flex justify-center md:justify-start">
            <!-- imagen redonda incluida en texto: si quieres sustituirla, moderadores pueden -->
            <img id="brand-image" class="round-img" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='300'><rect width='100%' height='100%' fill='%23000000'/><text x='50%' y='50%' font-size='40' fill='%23ffffff' dominant-baseline='middle' text-anchor='middle'>AJ</text></svg>" alt="AJ Logo"/>
          </div>

          <div>
            <h3 class="text-2xl font-bold">Somos AJ Hats — dos adolescentes, mucho hustle 🚀</h3>
            <p class="mt-2 muted">Somos 2 adolescentes que sin dinero sacaron todo esto adelante. Creamos gorras con actitud y ganas de crecer. Compra con nosotros y apoya algo hecho desde cero. 💪</p>

            <div class="mt-4">
              <p class="font-semibold">¿Quieres saber más?</p>
              <p class="muted">Contáctanos por correo o deja tu opinión en la pestaña de opiniones. Si eres moderador, entra a la pestaña 🔧 Moderadores para gestionar la tienda.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- OPINIONES -->
      <section id="opiniones" class="tab p-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Opiniones de compradores 🗣️</h2>

        <!-- leave review -->
        <div class="mb-6">
          <textarea id="review-text" placeholder="Deja tu opinión..." class="w-full p-3 border rounded-lg" rows="3"></textarea>
          <div class="flex items-center gap-3 mt-2">
            <input id="review-name" placeholder="Tu nombre (opcional)" class="p-2 border rounded" />
            <button id="submit-review" class="px-4 py-2 bg-black text-white rounded">Enviar ⭐</button>
          </div>
        </div>

        <!-- reviews list -->
        <div id="reviews-list" class="space-y-3">
          <!-- render reviews -->
        </div>
      </section>

      <!-- CONTACTO -->
      <section id="contacto" class="tab p-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Contacto 📬</h2>
        <p class="muted mb-4">¿Preguntas? Escríbenos: <a class="underline" href="mailto:zzzbrain6@gmail.com">zzzbrain6@gmail.com</a></p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-4 border rounded">
            <h4 class="font-semibold">Mail</h4>
            <p class="muted">Haz clic para enviar un correo ✉️</p>
            <a href="mailto:zzzbrain6@gmail.com" class="mt-2 inline-block px-4 py-2 tab rounded">Enviar correo</a>
          </div>
          <div class="p-4 border rounded">
            <h4 class="font-semibold">Nequi</h4>
            <p class="muted">Pago via Nequi. Cuando compres, coordina por el número que aparece al pagar.</p>
          </div>
        </div>
      </section>

      <!-- MODERADORES -->
      <section id="moderadores" class="tab p-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Moderadores 🔧 (Acceso restringido)</h2>

        <div id="mod-login" class="mb-4">
          <input id="mod-code" type="password" placeholder="Introduce tu código secreto" class="p-2 border rounded mr-2" />
          <button id="mod-login-btn" class="px-4 py-2 bg-black text-white rounded">Entrar</button>
          <span id="mod-status" class="ml-4 muted">No autenticado</span>
        </div>

        <div id="mod-panel" class="space-y-4 hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 border rounded">
              <h4 class="font-semibold">Editar precio base</h4>
              <div class="flex gap-2 mt-2">
                <input id="price-input" type="number" class="p-2 border rounded w-40" />
                <button id="save-price" class="px-3 py-2 bg-black text-white rounded">Guardar</button>
              </div>
              <p class="muted mt-2">Precio en COP. Valor inicial: 90000</p>
            </div>

            <div class="p-4 border rounded">
              <h4 class="font-semibold">Subir imagen / video de marca</h4>
              <input id="brand-file" type="file" accept="image/*,video/*" class="mt-2" />
              <div id="brand-preview" class="mt-3"></div>
              <button id="save-brand" class="mt-2 px-3 py-2 bg-black text-white rounded">Guardar</button>
            </div>
          </div>

          <div class="p-4 border rounded">
            <h4 class="font-semibold">Gestionar gorras (añadir/editar/eliminar)</h4>
            <form id="add-card-form" class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
              <input id="card-name" placeholder="Nombre gorra" class="p-2 border rounded col-span-1 md:col-span-1" />
              <input id="card-price" type="number" placeholder="Precio (COP)" class="p-2 border rounded col-span-1 md:col-span-1" />
              <input id="card-media" type="file" accept="image/*,video/*" class="p-2 border rounded col-span-1 md:col-span-1" />
              <textarea id="card-desc" placeholder="Descripción" class="p-2 border rounded col-span-1 md:col-span-3"></textarea>
              <button id="add-card-btn" class="px-4 py-2 bg-black text-white rounded col-span-1 md:col-span-3">Añadir gorra</button>
            </form>
            <p class="muted mt-2">Solo moderadores pueden añadir, editar o eliminar las cards.</p>
          </div>

          <div class="p-4 border rounded">
            <h4 class="font-semibold">Opiniones — moderar</h4>
            <div id="mod-reviews" class="space-y-3 mt-3"></div>
          </div>
        </div>
      </section>

    </main>

    <!-- CART PANEL (modal-like) -->
    <div id="cart-panel" class="fixed right-4 bottom-4 w-full max-w-md sm:max-w-sm z-50 hidden">
      <div class="bg-white p-4 rounded-lg shadow-lg border">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Tu carrito 🛒</h3>
          <div class="flex gap-2">
            <button id="empty-cart" class="px-2 py-1 tab">Vaciar</button>
            <button id="close-cart" class="px-2 py-1 tab">Cerrar</button>
          </div>
        </div>
        <div id="cart-items" class="mt-3 space-y-3 max-h-56 overflow-auto"></div>
        <div class="mt-3 flex items-center justify-between">
          <div class="font-semibold">Total: <span id="cart-total">0 COP</span></div>
          <button id="checkout" class="px-4 py-2 bg-black text-white rounded">Comprar</button>
        </div>
      </div>
    </div>

    <!-- FULLSCREEN BUY OVERLAY -->
    <div id="buy-overlay" class="overlay hidden" aria-hidden="true">
      <div class="bg-black w-full h-full flex items-center justify-center">
        <div class="bg-white text-center p-8 rounded-lg max-w-lg mx-4">
          <p class="text-lg font-semibold mb-4">📲 Para completar tu compra:</p>
          <p class="mb-6">Escríbenos al número <strong>3158715277</strong> para coordinar tu pago y envío.</p>
          <button id="close-buy" class="px-4 py-2 bg-black text-white rounded">Entendido</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    /***********************
     * AJ HATS - Single File
     * Persistencia via localStorage (prototipo)
     * Moderador: validar con código secreto local (secreto, no mostrado en la UI)
     ************************/

    /********** CONFIG y UTIL **********/
    const DEFAULT_PRICE = 90000;
    // Secret moderator codes (verificación local)
    const MOD_CODES = ["1552","2012"];

    // Helpers: escape HTML (básico) para evitar inyección de HTML
    function escapeHtml(str = "") {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // read/write local storage safe wrappers
    const store = {
      get(k, fallback) {
        try { return JSON.parse(localStorage.getItem(k)) ?? fallback; } catch(e){ return fallback; }
      },
      set(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
    };

    // initial data
    let cards = store.get('aj_cards', null);
    if(!cards){
      cards = [
        { id: cryptoRandomId(), name: "Classic Black", price: DEFAULT_PRICE, desc: "Clásica, minimal y versátil. 🖤", mediaType:"image", mediaData: placeholderDataURI("black") },
        { id: cryptoRandomId(), name: "Street White", price: DEFAULT_PRICE, desc: "Blanca con actitud. 🤍", mediaType:"image", mediaData: placeholderDataURI("white") },
        { id: cryptoRandomId(), name: "Retro Red", price: DEFAULT_PRICE, desc: "Vibra retro para tu outfit. 🔴", mediaType:"image", mediaData: placeholderDataURI("red") }
      ];
      store.set('aj_cards', cards);
    }

    let reviews = store.get('aj_reviews', []);
    let cart = store.get('aj_cart', []);
    let priceBase = store.get('aj_price', DEFAULT_PRICE);
    let brandMedia = store.get('aj_brand', null);
    let modSession = store.get('aj_mod', {authenticated:false});

    // safe simple placeholder images (svg data uri)
    function placeholderDataURI(text){
      const bg = "#e6e6e6";
      const fg = "#000000";
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='${bg}'/><text x='50%' y='50%' font-size='40' fill='${fg}' dominant-baseline='middle' text-anchor='middle'>${text}</text></svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    function cryptoRandomId(){ return Math.random().toString(36).slice(2,10); }

    /********** UI SELECTORS **********/
    const tabs = document.querySelectorAll('nav button[data-tab]');
    const sections = { tienda:document.getElementById('tienda'), nosotros:document.getElementById('nosotros'), opiniones:document.getElementById('opiniones'), contacto:document.getElementById('contacto'), moderadores:document.getElementById('moderadores') };
    const cardsGrid = document.getElementById('cards-grid');
    const priceDisplay = document.getElementById('price-display');
    const cartCount = document.getElementById('cart-count');

    const reviewsList = document.getElementById('reviews-list');
    const reviewText = document.getElementById('review-text');
    const reviewName = document.getElementById('review-name');

    const cartPanel = document.getElementById('cart-panel');
    const openCartBtn = document.getElementById('open-cart');
    const closeCartBtn = document.getElementById('close-cart');
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    const emptyCartBtn = document.getElementById('empty-cart');
    const checkoutBtn = document.getElementById('checkout');

    const buyOverlay = document.getElementById('buy-overlay');
    const closeBuy = document.getElementById('close-buy');

    // moderator elements
    const modLoginBtn = document.getElementById('mod-login-btn');
    const modCodeInput = document.getElementById('mod-code');
    const modStatus = document.getElementById('mod-status');
    const modPanel = document.getElementById('mod-panel');

    const priceInput = document.getElementById('price-input');
    const savePriceBtn = document.getElementById('save-price');

    const addCardForm = document.getElementById('add-card-form');
    const addCardBtn = document.getElementById('add-card-btn');
    const cardName = document.getElementById('card-name');
    const cardPrice = document.getElementById('card-price');
    const cardMedia = document.getElementById('card-media');
    const cardDesc = document.getElementById('card-desc');

    const modReviewsDiv = document.getElementById('mod-reviews');

    const brandFile = document.getElementById('brand-file');
    const brandPreview = document.getElementById('brand-preview');
    const saveBrandBtn = document.getElementById('save-brand');
    const brandImageEl = document.getElementById('brand-image');

    const ctaShop = document.getElementById('cta-shop');

    /********** INIT **********/
    // set initial tab
    function openTab(name){
      Object.values(sections).forEach(s => s.classList.add('hidden'));
      if(sections[name]) sections[name].classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    openTab('tienda');

    tabs.forEach(t=> t.addEventListener('click', ()=> openTab(t.dataset.tab)));
    ctaShop.addEventListener('click', ()=> openTab('tienda'));

    // initial render
    function render(){
      priceDisplay.textContent = `${Number(priceBase).toLocaleString('es-CO')} COP`;
      priceInput.value = priceBase;
      renderCards();
      renderReviews();
      renderCart();
      renderModReviews();
      if(brandMedia) {
        // show brand media
        if(brandMedia.type.startsWith('image')) brandImageEl.src = brandMedia.data;
        else {
          // show poster frame for video
          brandImageEl.src = placeholderDataURI('Video de marca');
        }
      }
      // mod session
      if(modSession.authenticated) {
        modStatus.textContent = 'Autenticado como moderador';
        modPanel.classList.remove('hidden');
      } else {
        modStatus.textContent = 'No autenticado';
        modPanel.classList.add('hidden');
      }
    }

    // render product cards
    function renderCards(){
      cardsGrid.innerHTML = '';
      cards.forEach(card=>{
        const col = document.createElement('div');
        col.className = 'p-4 border rounded flex flex-col gap-3';
        // media (image or video thumbnail)
        let mediaHtml = '';
        if(card.mediaType === 'video'){
          mediaHtml = `<video class="media-thumb" src="${card.mediaData}" controls muted playsinline></video>`;
        } else {
          mediaHtml = `<img class="media-thumb" src="${card.mediaData}" alt="${escapeHtml(card.name)}"/>`;
        }
        col.innerHTML = `
          <div class="flex-0">${mediaHtml}</div>
          <div class="flex-1">
            <h4 class="font-semibold">${escapeHtml(card.name)}</h4>
            <p class="muted text-sm">${escapeHtml(card.desc)}</p>
            <div class="mt-3 flex items-center justify-between">
              <div class="font-semibold">${Number(card.price).toLocaleString('es-CO')} COP</div>
              <div class="flex items-center gap-2">
                <button class="add-cart px-3 py-1 tab" data-id="${card.id}">Añadir</button>
                <button class="view-card px-3 py-1 tab" data-id="${card.id}">Ver</button>
              </div>
            </div>
          </div>
        `;
        // moderator controls (only rendered if authenticated)
        if(modSession.authenticated){
          const modControls = document.createElement('div');
          modControls.className = 'mt-3 flex gap-2';
          modControls.innerHTML = `<button class="edit-card px-3 py-1 tab" data-id="${card.id}">Editar</button>
                                   <button class="delete-card px-3 py-1 tab" data-id="${card.id}">Eliminar</button>`;
          col.appendChild(modControls);
        }
        cardsGrid.appendChild(col);
      });

      // attach card listeners (delegation could be used; simple approach)
      document.querySelectorAll('.add-cart').forEach(btn=>{
        btn.onclick = ()=> {
          const id = btn.dataset.id;
          addToCart(id);
        };
      });
      document.querySelectorAll('.delete-card').forEach(btn=>{
        btn.onclick = ()=> {
          const id = btn.dataset.id;
          if(confirm('Eliminar esta gorra permanentemente?')) {
            cards = cards.filter(c => c.id !== id);
            store.set('aj_cards', cards);
            render();
          }
        };
      });
      document.querySelectorAll('.edit-card').forEach(btn=>{
        btn.onclick = ()=> {
          const id = btn.dataset.id;
          openEditCardModal(id);
        };
      });
      document.querySelectorAll('.view-card').forEach(btn=>{
        btn.onclick = ()=> {
          const id = btn.dataset.id;
          openViewCardModal(id);
        };
      });
    }

    /********** CART **********/
    function addToCart(id){
      const product = cards.find(c=>c.id===id);
      if(!product) return;
      cart.push({ lineId: cryptoRandomId(), productId: product.id, name: product.name, price: product.price });
      store.set('aj_cart', cart);
      renderCart();
      alert('Añadido al carrito ✨');
    }

    function renderCart(){
      cartCount.textContent = cart.length;
      cartItems.innerHTML = '';
      let total = 0;
      cart.forEach(item=>{
        total += Number(item.price);
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between';
        div.innerHTML = `<div><div class="font-medium">${escapeHtml(item.name)}</div><div class="muted text-sm">${Number(item.price).toLocaleString('es-CO')} COP</div></div>
                         <div class="flex items-center gap-2">
                           <button class="remove-line px-2 py-1 tab" data-line="${item.lineId}">Eliminar</button>
                         </div>`;
        cartItems.appendChild(div);
      });
      cartTotal.textContent = `${Number(total).toLocaleString('es-CO')} COP`;

      document.querySelectorAll('.remove-line').forEach(b=>{
        b.onclick = ()=> {
          const line = b.dataset.line;
          cart = cart.filter(c => c.lineId !== line);
          store.set('aj_cart', cart);
          renderCart();
        };
      });
    }

    openCartBtn.addEventListener('click', ()=>{
      cartPanel.classList.toggle('hidden');
    });
    closeCartBtn.addEventListener('click', ()=> cartPanel.classList.add('hidden'));
    emptyCartBtn.addEventListener('click', ()=>{
      if(confirm('Vaciar carrito?')) {
        cart = [];
        store.set('aj_cart', cart);
        renderCart();
      }
    });

    checkoutBtn.addEventListener('click', ()=> {
      // on checkout show overlay with instructions (black screen + centered white message)
      buyOverlay.classList.remove('hidden');
      buyOverlay.setAttribute('aria-hidden','false');
    });
    closeBuy.addEventListener('click', ()=> {
      buyOverlay.classList.add('hidden');
      buyOverlay.setAttribute('aria-hidden','true');
    });

    /********** REVIEWS **********/
    document.getElementById('submit-review').addEventListener('click', ()=>{
      const text = reviewText.value.trim();
      if(!text) return alert('Escribe tu opinión primero 😊');
      const name = reviewName.value.trim() || 'Anon';
      const rev = { id: cryptoRandomId(), name: escapeHtml(name), text: escapeHtml(text), resolved:false, created: Date.now() };
      reviews.unshift(rev);
      store.set('aj_reviews', reviews);
      reviewText.value = '';
      reviewName.value = '';
      renderReviews();
      renderModReviews();
      alert('Gracias por tu opinión! 🙌');
    });

    function renderReviews(){
      reviewsList.innerHTML = '';
      reviews.forEach(r=>{
        const div = document.createElement('div');
        div.className = 'p-3 border rounded';
        div.innerHTML = `<div class="flex items-center justify-between"><strong>${r.name}</strong><span class="muted text-sm">${new Date(r.created).toLocaleString()}</span></div>
                         <p class="mt-2">${r.text}</p>
                         <div class="mt-2 flex gap-2">
                            ${r.resolved ? '<span class="text-sm tab">Resuelta ✅</span>' : '<span class="text-sm tab">Pendiente ⏳</span>'}
                         </div>`;
        reviewsList.appendChild(div);
      });
    }

    function renderModReviews(){
      modReviewsDiv.innerHTML = '';
      reviews.forEach(r=>{
        const d = document.createElement('div');
        d.className = 'p-3 border rounded';
        d.innerHTML = `<div class="flex items-center justify-between">
                        <div><strong>${r.name}</strong><div class="muted text-sm">${new Date(r.created).toLocaleString()}</div></div>
                        <div class="flex gap-2">
                          ${r.resolved ? '' : `<button class="resolve-review px-2 py-1 tab" data-id="${r.id}">Resolver</button>`}
                          <button class="delete-review px-2 py-1 tab" data-id="${r.id}">Eliminar</button>
                        </div>
                       </div>
                       <p class="mt-2">${r.text}</p>`;
        modReviewsDiv.appendChild(d);
      });
      document.querySelectorAll('.resolve-review').forEach(b=>{
        b.onclick = ()=> {
          const id = b.dataset.id;
          reviews = reviews.map(r => r.id===id ? {...r, resolved:true} : r);
          store.set('aj_reviews', reviews);
          renderReviews();
          renderModReviews();
        };
      });
      document.querySelectorAll('.delete-review').forEach(b=>{
        b.onclick = ()=> {
          const id = b.dataset.id;
          if(confirm('Eliminar opinión?')) {
            reviews = reviews.filter(r => r.id !== id);
            store.set('aj_reviews', reviews);
            renderReviews();
            renderModReviews();
          }
        };
      });
    }

    /********** MODERATOR AUTH & PANEL **********/
    modLoginBtn.addEventListener('click', ()=>{
      const code = String(modCodeInput.value || '').trim();
      if(MOD_CODES.includes(code)){
        modSession = { authenticated:true, ts: Date.now() };
        store.set('aj_mod', modSession);
        modCodeInput.value = '';
        alert('Acceso de moderador concedido ✅');
        render();
      } else {
        alert('Código incorrecto 🔒');
      }
    });

    savePriceBtn.addEventListener('click', ()=>{
      if(!modSession.authenticated) return alert('Solo moderadores');
      const p = Number(priceInput.value);
      if(!p || p<=0) return alert('Precio inválido');
      priceBase = p;
      // update all products default price? We'll only set base and optionally allow card-specific price
      store.set('aj_price', priceBase);
      render();
      alert('Precio base actualizado');
    });

    // brand file preview + save
    brandFile.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      if(f.size > 3_000_000) return alert('Archivo muy grande (máx 3MB)');
      const allowed = ['image/','video/'];
      if(!allowed.some(a=>f.type.startsWith(a))) return alert('Tipo no permitido');
      const data = await fileToDataUrl(f);
      brandPreview.innerHTML = f.type.startsWith('image/') ? `<img class="media-thumb" src="${data}"/>` : `<video class="media-thumb" src="${data}" controls></video>`;
      brandPreview.dataset.pending = data;
    });
    saveBrandBtn.addEventListener('click', ()=>{
      if(!modSession.authenticated) return alert('Solo moderadores');
      const pending = brandPreview.dataset.pending;
      if(!pending) return alert('No hay archivo seleccionado');
      brandMedia = { type: pending.startsWith('data:video') ? 'video' : 'image', data: pending };
      store.set('aj_brand', brandMedia);
      brandPreview.dataset.pending = '';
      brandPreview.innerHTML = '';
      render();
      alert('Media de marca guardada ✅');
    });

    // add card
    addCardBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      if(!modSession.authenticated) return alert('Solo moderadores');
      const name = cardName.value.trim();
      const desc = cardDesc.value.trim();
      const p = Number(cardPrice.value) || priceBase;
      const f = cardMedia.files[0];
      if(!name || !desc) return alert('Completa nombre y descripción');
      let mediaType = 'image';
      let mediaData = placeholderDataURI('Gorra');
      if(f){
        if(f.size > 4_000_000) return alert('Archivo muy grande (max 4MB)');
        if(!f.type.startsWith('image') && !f.type.startsWith('video')) return alert('Tipo no permitido');
        mediaData = await fileToDataUrl(f);
        mediaType = f.type.startsWith('video') ? 'video' : 'image';
      }
      const newCard = { id: cryptoRandomId(), name: escapeHtml(name), price: p, desc: escapeHtml(desc), mediaType, mediaData };
      cards.unshift(newCard);
      store.set('aj_cards', cards);
      cardName.value = ''; cardDesc.value=''; cardPrice.value='';
      cardMedia.value = null;
      render();
      alert('Gorra añadida ✅');
    });

    // helper: convert file to dataURL
    function fileToDataUrl(file){
      return new Promise((res, rej)=>{
        const reader = new FileReader();
        reader.onload = ()=> res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
    }

    /********** EDIT CARD (simple modal emulated with prompt) **********/
    function openEditCardModal(id){
      if(!modSession.authenticated) return alert('Solo moderadores');
      const card = cards.find(c=>c.id===id);
      if(!card) return;
      // simple prompts (keeps prototype single-file)
      const newName = prompt('Nombre de la gorra:', card.name);
      if(newName === null) return;
      const newPrice = prompt('Precio (COP):', card.price);
      if(newPrice === null) return;
      const newDesc = prompt('Descripción:', card.desc);
      if(newDesc === null) return;
      card.name = escapeHtml(newName.trim()) || card.name;
      card.price = Number(newPrice) || card.price;
      card.desc = escapeHtml(newDesc.trim()) || card.desc;
      store.set('aj_cards', cards);
      render();
      alert('Gorra actualizada ✅');
    }

    function openViewCardModal(id){
      const card = cards.find(c=>c.id===id);
      if(!card) return;
      // small viewer
      let content = `${card.name}\n${card.desc}\nPrecio: ${Number(card.price).toLocaleString('es-CO')} COP`;
      alert(content);
    }

    /********** MOD REVIEWS (renders already defined) **********/
    // already handled in renderModReviews

    /********** SMALL EDITORIAL: allow moderators to edit page HTML? **********/
    // For safety, we DO NOT allow direct arbitrary JS/HTML edits via the UI in this prototype.
    // Moderadores pueden editar gorras, precio, imágenes, videos y opiniones. Para editar la estructura de la página,
    // se recomienda editar el archivo fuente en servidor o implementar panel backend con auth.

    /********** UTILS *******/

    function initListeners(){
      // buy overlay click handled earlier
      // attach delegation for dynamic buttons if needed (none)
    }

    /********** PAGE READY **********/
    render();
    initListeners();

    /********** SECURITY NOTES (runtime) **********/
    // - Sanitizamos texto con escapeHtml al mostrar.
    // - Validamos tipos y tamaños de ficheros en cliente antes de aceptar.
    // - Persistencia via localStorage (prototipo). NO usar esto para datos sensibles o pagos reales.
    // - Para producción usar backend autenticado, HTTPS, validación del lado servidor, tokens, y evitar exponer códigos en el cliente.

    /********** SMALL USER-FRIENDLY HELPERS **********/
    // simple modal replacement: instructive alerts used to keep single-file simple.

    /********** END **********/
  </script>

</body>
</html>
